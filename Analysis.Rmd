---
title: "Protein on viability"
author: "Erin Macartney"
date: "21/01/2022"
output: 
    rmdformats::readthedown:
      code_folding: hide
      code_download: true
      toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE,
cache = TRUE, 
tidy = TRUE, 
echo = TRUE
)

rm(list = ls())
```


# Setting-up {.tabset}

## Loading packages
```{r}
pacman::p_load(lme4,
               here,
               car,
               tidyverse,
               ggpubr)
```

## Loading data
```{r}
dat <- read.csv(here("Data","Protein_viability.csv"))
```

## Sample sizes
```{r}
count(dat, lifestage)
count(dat, parent)
```

## Making data long-form 
```{r}
dat1<- dat %>%
  pivot_longer(cols = ends_with("_protein"), names_to = "treatment", values_to = "viability")
```

# Analysis 

## Linear models {.tabset}

### Simlpe linear model
No effect of treatment on viability
```{r}
m1 <- lm(logit(viability) ~ treatment, dat = dat1)
summary(m1)
```

### Including parental sex
Also no effect

#### With males included
```{r}
m2 <- lm(logit(viability) ~ treatment + parent, dat = dat1)
summary(m2)
```

#### With males excluded
```{r}
dat1_nomales <- filter(dat1, parent %in% c("female", "both"))

m2a <- lm(logit(viability) ~ treatment + parent, dat = dat1_nomales)
summary(m2a)
```

### Including lifestage
Also no effect

#### With males included
```{r}
m3 <- lm(logit(viability) ~ treatment + parent + lifestage, dat = dat1)
summary(m3)
```

#### With males excluded
```{r}
m3a <- lm(logit(viability) ~ treatment + parent + lifestage, dat = dat1_nomales)
summary(m3a)
```


## Meta-analysis
* note that I haven't looked at each individual papers diet manipulations but I went to convert Nyasembe et al (2021) IQR to SD and noticed that the manipulation appears to be glucose rather than protein because its blood vs blood + glucose. Should we still include this? In the mean time, it's excluded. 

### Calucluting lnRR and Variance
``` {r}
#lnRR 

lnRR <- log(dat$high_protein) - log(dat$low_protein)

#I hope this is calculated correctly.
var <- (dat$high_sd)^2/((dat$n_HP)*(mean(dat$high_protein)^2)) + (dat$low_sd)^2/((dat$n_HP)*(mean(dat$low_protein)^2))

```


# Plotting

## Violin plot
``` {r}
p <- ggviolin(dat1_nomales, "treatment", "viability", color = "parent", add = c("jitter", "mean_sd"))
p
```
