---
title: "Protein on viability"
output: 
    rmdformats::readthedown:
      code_folding: hide
      code_download: true
      toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE,
#cache = TRUE, 
tidy = TRUE, 
echo = TRUE
)

rm(list = ls())
```


# Setting-up {.tabset}

## Loading packages
```{r}
pacman::p_load(lme4,
               here,
               car,
               tidyverse,
               ggpubr,
               orchaRd,
               metafor)
```

## Loading data
```{r}
dat <- read.csv(here("Data","Protein_viability.csv"))
```

## Sample sizes
```{r}
count(dat, lifestage)
count(dat, parent)
```

## Making data long-form 
```{r}
dat1<- dat %>%
  pivot_longer(cols = ends_with("_protein"), names_to = "treatment", values_to = "viability")
```

# Analysis 

## Linear models {.tabset}

### Simlpe linear model
No effect of treatment on viability
```{r}

m1 <- lm(logit(viability) ~ treatment, dat = dat1)
summary(m1)
```

### Including parental sex
Also no effect

#### With males included
```{r}
m2 <- lm(logit(viability) ~ treatment + parent, dat = dat1)
summary(m2)
```

#### With males excluded
```{r}
dat1_nomales <- filter(dat1, parent %in% c("female", "both"))

m2a <- lm(logit(viability) ~ treatment + parent, dat = dat1_nomales)
summary(m2a)
```

### Including lifestage
Also no effect

#### With males included
```{r}
m3 <- lm(logit(viability) ~ treatment + parent + lifestage, dat = dat1)
summary(m3)
```

#### With males excluded
```{r}
m3a <- lm(logit(viability) ~ treatment + parent + lifestage, dat = dat1_nomales)
summary(m3a)
```

### Violin plot
```{r}

violin <- ggviolin(dat1, "treatment", "viability", color = "parent", add = c("jitter", "mean_sd"), add.params = list(shape = "triangle"))
violin
```

## Meta-analysis
* note that I haven't looked at each individual papers diet manipulations but I went to convert Nyasembe et al (2021) IQR to SD and noticed that the manipulation appears to be of glucose rather than protein because its blood vs blood + glucose. Should we still include this? In the mean time, it's excluded. 

### Calucluting lnRR and Variance
There is a package that does this but I have never used it before so it was easier for me to do manually. 
``` {r}
dat2 <- dat %>%
  drop_na()

#transforming data

#transforming mean
asin_trans <- function(percent) { asin(sqrt(percent/100)) }
dat2$high_protein_asin <- asin_trans(dat2$high_protein) 
dat2$low_protein_asin <- asin_trans(dat2$low_protein)

#transforming SD
dat2$high_sd_transform <- sqrt((dat2$high_sd/100)^2/(4*(dat2$high_protein/100)*(1-(dat2$high_protein/100))))
dat2$low_sd_transform <- sqrt((dat2$low_sd/100)^2/(4*(dat2$low_protein/100)*(1-(dat2$low_protein/100))))

#lnRR 
dat2$lnRR <- log(dat2$high_protein_asin) - log(dat2$low_protein_asin)

#variance
dat2$var <- (dat2$high_sd_transform)^2/((dat2$n_HP)*(mean(dat2$high_protein_asin)^2)) + (dat2$low_sd_transform)^2/((dat2$n_HP)*(mean(dat2$low_protein_asin)^2))
```

## Meta-analytic model {.tabset}
Note that I haven't included species because each paper nearly uses a different species which will make species and paperID non-indentifiable.This is almost nearly the case with paper ID and esID. 

No significant difference but a trend towards lower viability on high protein. 

### Main model
```{r}

m4 <- rma.mv(yi = lnRR, V = var, random = list(~1|esID,
                                               ~1|paperID),
                 test = "t",
                 data = dat2)
summary(m4) 
i2_ml(m4)

orchard<- orchard_plot(m4, mod = "Int", xlab = "lnRR", alpha=0.4) +  # Orchard plot 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5)+ # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2)+ # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  # scale_colour_manual(values = "darkorange")+ # change colours
  # scale_fill_manual(values="darkorange")+ 
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 

orchard
```

### Meta-regression of parent
Parent explains ~5% of total varition with a trend for a stronger reduction in viability with high protein in females (although k should be taken into consideration)

```{r}
m4a <- rma.mv(yi = lnRR, V = var, mod = ~parent-1, random = list(~1|esID,
                                               ~1|paperID),
                 test = "t",
                 data = dat2)
summary(m4a) 
r2_ml(m4a)

orchard2 <- orchard_plot(m4a, mod = "parent", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

orchard2
```

